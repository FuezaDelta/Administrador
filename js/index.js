import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    getDocs,
    collection,
    updateDoc // Importar updateDoc para actualizar solo ciertos campos
} from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyA8HzpUL5LAvOCk6nmZvd_mB2vAB7FSYME",
    authDomain: "fuerza-delta.firebaseapp.com",
    projectId: "fuerza-delta",
    storageBucket: "fuerza-delta.appspot.com",
    messagingSenderId: "273501560145",
    appId: "1:273501560145:web:e6f01a832b054e01e1c770"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

document.getElementById("fechaNacimiento").addEventListener("change", function () {
    const nacimiento = new Date(this.value);
    const hoy = new Date();
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mes = hoy.getMonth() - nacimiento.getMonth();
    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }
    document.getElementById("edad").value = edad;
});

window.buscarCliente = async function () {
    const cedula = document.getElementById("cedula").value;
    if (!cedula) {
        alert("Por favor ingresa una c√©dula para buscar.");
        return;
    }
    const ref = doc(db, "clientes", cedula);
    const snap = await getDoc(ref);
    if (snap.exists()) {
        const c = snap.data();
        llenarFormulario(c); // Usar la nueva funci√≥n para llenar el formulario
        const hoy = new Date();
        const fechaVencimiento = new Date(c.fechaVencimiento);
        const estado = hoy <= fechaVencimiento
            ? "<span class='estado-activo'>Activo</span>"
            : "<span class='estado-vencido'>Vencido</span>";
        document.getElementById("resultado").innerHTML =
            `Cliente encontrado. Estado de la membres√≠a: ${estado}`;
    } else {
        document.getElementById("resultado").innerText = "‚ö†Ô∏è Cliente no encontrado. Puedes registrar uno nuevo.";
        document.getElementById("registro").reset();
        document.getElementById("cedula").value = cedula;
    }
};

window.buscarClientePorApellido = async function () {
    const apellidoBusqueda = document.getElementById("apellidoBusqueda").value;
    const resultadosContainer = document.getElementById("resultadosBusquedaApellido");

    if (!apellidoBusqueda) {
        alert("Por favor ingresa un nombre o apellido para buscar.");
        resultadosContainer.innerHTML = "";
        return;
    }

    resultadosContainer.innerHTML = `<p>Buscando clientes cuyo nombre contiene: <strong>${apellidoBusqueda}</strong>...</p>`;

    try {
        const clientesSnap = await getDocs(collection(db, "clientes"));
        let listaHTML = `<h3>Clientes encontrados cuyo nombre contiene: ${apellidoBusqueda}</h3><ul>`;

        clientesSnap.forEach((docu) => {
            const data = docu.data();
            if (data.nombre && data.nombre.toLowerCase().includes(apellidoBusqueda.toLowerCase())) {
                listaHTML += `<li style="cursor: pointer;" data-cedula="${docu.id}"><strong>${data.nombre}</strong> - C√©dula: ${data.cedula} - Tel√©fono: ${data.telefono || 'No registrado'} - Vencimiento: ${data.fechaVencimiento || 'No registrada'}</li>`;
            }
        });

        listaHTML += "</ul>";
        resultadosContainer.innerHTML = listaHTML;

        const listaItems = resultadosContainer.querySelectorAll('li');
        listaItems.forEach(item => {
            item.addEventListener('click', async function () {
                const cedulaSeleccionada = this.getAttribute('data-cedula');
                if (cedulaSeleccionada) {
                    const ref = doc(db, "clientes", cedulaSeleccionada);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const clienteData = snap.data();
                        llenarFormulario(clienteData);
                        document.getElementById("resultado").innerHTML = `‚úÖ Cliente <strong>${clienteData.nombre}</strong> seleccionado.`;
                    } else {
                        document.getElementById("resultado").innerHTML = `‚ö†Ô∏è No se encontr√≥ informaci√≥n para la c√©dula: ${cedulaSeleccionada}.`;
                    }
                }
            });
        });

        if (listaHTML === `<h3>Clientes encontrados cuyo nombre contiene: ${apellidoBusqueda}</h3><ul></ul>`) {
            resultadosContainer.innerHTML = `<p>No se encontraron clientes cuyo nombre contenga: <strong>${apellidoBusqueda}</strong>.</p>`;
        }

    } catch (error) {
        console.error("Error al buscar por nombre o apellido: ", error);
        resultadosContainer.innerHTML = "<p class='error'>‚ùå Error al realizar la b√∫squeda.</p>";
    }
};

document.getElementById("registro").addEventListener("submit", async function (e) {
    e.preventDefault();

    const nombre = document.getElementById("nombre").value;
    const cedula = document.getElementById("cedula").value;
    const telefono = document.getElementById("telefono").value;
    const fechaNacimiento = document.getElementById("fechaNacimiento").value;
    const edad = parseInt(document.getElementById("edad").value);
    const sexo = document.getElementById("sexo").value;
    const plan = parseInt(document.getElementById("plan").value);
    const valorPagado = parseInt(document.getElementById("valorPagado").value);
    const fechaIngreso = new Date(document.getElementById("fechaIngreso").value);

    const fechaVencimiento = new Date(fechaIngreso);
    fechaVencimiento.setMonth(fechaVencimiento.getMonth() + plan);
    const fechaIngresoStr = fechaIngreso.toISOString().split('T')[0];
    const fechaVencimientoStr = fechaVencimiento.toISOString().split('T')[0];

    try {
        // Al registrar o actualizar, resetear el estado de la notificaci√≥n de vencimiento
        await setDoc(doc(db, "clientes", cedula), {
            nombre,
            cedula,
            telefono,
            fechaNacimiento,
            edad,
            sexo,
            plan,
            valorPagado,
            fechaIngreso: fechaIngresoStr,
            fechaVencimiento: fechaVencimientoStr,
            // Nuevo campo: al registrar/actualizar, no se ha enviado la notificaci√≥n de "vence ma√±ana" para este nuevo ciclo
            notificacionVencimientoMa√±anaEnviada: false 
        });

        const hoy = new Date();
        const estado = hoy <= fechaVencimiento
            ? "<span class='estado-activo'>Activo</span>"
            : "<span class='estado-vencido'>Vencido</span>";

        document.getElementById("resultado").innerHTML =
            `‚úÖ Cliente <strong>${nombre}</strong> actualizado correctamente.<br>Su membres√≠a vence el <strong>${fechaVencimientoStr}</strong>.<br>Estado: ${estado}`;

        verificarVencimientos(); // Vuelve a verificar y actualizar la lista de vencimientos

    } catch (error) {
        console.error("Error al registrar: ", error);
        document.getElementById("resultado").innerText = "‚ùå Error al guardar los datos.";
    }
});

// Funci√≥n para actualizar el estado de notificaci√≥n en Firebase
window.marcarNotificacionEnviada = async function (cedula) {
    try {
        const clienteRef = doc(db, "clientes", cedula);
        await updateDoc(clienteRef, {
            notificacionVencimientoMa√±anaEnviada: true
        });
        console.log(`Notificaci√≥n de vencimiento marcada como enviada para: ${cedula}`);
    } catch (error) {
        console.error("Error al actualizar la notificaci√≥n en Firestore: ", error);
    }
}

async function verificarVencimientos() {
    const container = document.getElementById("vencenManana");
    container.innerHTML = "";

    const ma√±ana = new Date();
    ma√±ana.setDate(ma√±ana.getDate() + 1);
    // Para asegurar que la comparaci√≥n de fechas sea solo por el d√≠a, mes y a√±o, 
    // y no por la hora, minutos, segundos, que pueden causar discrepancias.
    const fechaObjetivo = ma√±ana.toISOString().split("T")[0];

    const clientesSnap = await getDocs(collection(db, "clientes"));
    clientesSnap.forEach((docu) => {
        const data = docu.data();
        // Compara la fecha de vencimiento del cliente con la fecha objetivo (ma√±ana)
        // Y verifica si la notificaci√≥n para "vence ma√±ana" ya fue enviada
        if (data.fechaVencimiento === fechaObjetivo) {
            const mensaje = encodeURIComponent(`Hola ${data.nombre}, te saludamos desde el gimnasio Fuerza Delta. Tu membres√≠a vence el ${data.fechaVencimiento}. Te esperamos para renovar y seguir entrenandoüí™üèª!. √âste es un mensaje autom√°tico. Muchas gracias.`);
            const link = `https://wa.me/57${data.telefono}?text=${mensaje}`;

            const div = document.createElement("div");
            let buttonHtml = '';

            // Si la notificaci√≥n ya fue enviada para esta fecha de vencimiento, muestra el check
            // Aseg√∫rate de que el campo exista y sea true
            if (data.notificacionVencimientoMa√±anaEnviada === true) {
                buttonHtml = '<span>‚úÖ WhatsApp enviado</span>';
            } else {
                // Si no ha sido enviada, muestra el bot√≥n y configura el onclick
                buttonHtml = `
                    <a class='whatsapp-link' target='_blank' href='${link}' 
                       onclick="this.outerHTML='<span>‚úÖ WhatsApp enviado</span>'; marcarNotificacionEnviada('${data.cedula}'); return true;">üì≤ Enviar WhatsApp</a>
                `;
            }
            
            div.innerHTML = `
                <strong>${data.nombre}</strong> (${data.telefono}) vence el ${data.fechaVencimiento}<br>
                ${buttonHtml}
                <br><br>
            `;
            container.appendChild(div);
        }
    });
}
    
// Llama a la funci√≥n al cargar la p√°gina para mostrar los clientes que vencen
verificarVencimientos();

function llenarFormulario(data) {
    document.getElementById("nombre").value = data.nombre || "";
    document.getElementById("telefono").value = data.telefono || "";
    document.getElementById("fechaNacimiento").value = data.fechaNacimiento || "";
    document.getElementById("edad").value = data.edad || "";
    document.getElementById("sexo").value = data.sexo || "Masculino";
    document.getElementById("plan").value = data.plan || "1";
    document.getElementById("fechaIngreso").value = data.fechaIngreso || "";
    document.getElementById("valorPagado").value = data.valorPagado || "";
    document.getElementById("cedula").value = data.cedula || "";
}